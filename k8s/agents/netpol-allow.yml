apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: agents
spec:
  podSelector: {}
  policyTypes: ["Ingress","Egress"]
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mesh-dns-boa-agents-and-external
  namespace: agents
spec:
  podSelector: {}
  policyTypes: ["Ingress","Egress"]
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          istio.io/rev: asm-managed
  egress:
  # 1) DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - { protocol: UDP, port: 53 }
    - { protocol: TCP, port: 53 }
  # 2) In-namespace service calls (copilot -> transactions-tool)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: agents
  # 3) BoA namespace (agents -> BoA services)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: boa
  # 4) External (managed ASM control plane etc.) for sidecars
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
